{% extends "base.html" %}
{% from "components/typography.html" import hero %}
{% from "components/ui.html" import button %}

{% block title %}TODO{% endblock %}

{% block content %}
<div class="bg-slate-50 p-8 font-primary">
  {% call hero("TODO LIST API TEST", "Test the ToDo List API with this simple interface") %}
        {{ info_modal(
            id="test",
            title=md_meta_i18n("docs/projects/todolist", "title"),
            text=md_page_i18n("docs/projects/todolist"),
            button_label="Infos"
        ) }}
    {% endcall %}

  <!-- üü© Formulaire -->
  <form id="form" class="mt-6 max-w-xl">
    <input
      type="text"
      id="task"
      class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-base shadow-sm
             focus:border-primary-500 focus:ring-2 focus:ring-primary-200 focus:outline-none"
      placeholder="Enter a new task..."
      required
    />
    {{ button("Add Task", variant="first", extra_class="mt-4") }}
  </form>

  <!-- üü® Liste des t√¢ches -->
  <p class="mt-6 max-w-xl text-center text-sm text-slate-600">
    Click on a task to delete it, click on the icon to toggle its status.
  </p>

  <ul
    id="task-list"
    class="mt-4 max-w-xl divide-y divide-slate-200 overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm"
  ></ul>
</div>
{% endblock %}

{% block js %}
  <script>
    // Construit l‚ÄôURL compl√®te de l‚ÄôAPI selon APP_ENV (dev/prod)
    // En dev: config['API_BASE_URL'] = "http://127.0.0.1:5000"
    // En prod: config['API_BASE_URL'] = ""
    window.API_BASE_URL = "{{ (config['API_BASE_URL'] or '') ~ '/api/todolist' }}";
  </script>
  <script>
    const BASE_URL = window.API_BASE_URL;
    // POST API to create a new task
    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const task = document.getElementById("task").value;
      const res = await fetch(BASE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task, done: false }),
      });
      const data = await res.json();
      console.log(data);
      alert("R√©ponse du serveur : " + JSON.stringify(data));

      document.getElementById("task").value = ""; // Clear input
      fetchTasks(); // Refresh the task list
    });
  
    // GET API to fetch and display tasks
    async function fetchTasks() {
      const res = await fetch(BASE_URL);
      const data = await res.json();
      
      const taskList = document.getElementById("task-list");
      taskList.innerHTML = ""; // Clear existing tasks
      data.forEach(task => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        // Raw structured in 2 columns
        const row = document.createElement("div");
        row.className = "d-flex justify-content-between align-items-center w-100";

        // Column 1: Icon for done status toggle
        const colIcon = document.createElement("div");
        const icon = document.createElement("span");
        icon.style.cursor = "pointer";
        icon.textContent = task.done ? "‚úÖ" : "üî∂";
        colIcon.appendChild(icon);
        row.appendChild(colIcon);
        icon.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent triggering the delete event
          updateTask(task.id, { done: !task.done });
        });

        // Column 2: Task Text
        const colText = document.createElement("div");
        colText.textContent = task.text;
        row.appendChild(colText);

        li.appendChild(row);

        taskList.appendChild(li);
        li.addEventListener("click", () => {
          const confirmed = confirm("Do you really want to delete this task ?");
          if (confirmed) {
            deleteTask(task.id);
          }
        });
      });
    }

    // DELETE API to remove a task
    async function deleteTask(taskId) {
      const res = await fetch(`${BASE_URL}/${taskId}`, {
        method: "DELETE",
      });
      if (res.ok) {
        alert("T√¢che supprim√©e avec succ√®s.");
        fetchTasks(); // Refresh the task list
      } else {
        const data = await res.json();
        alert("Erreur lors de la suppression de la t√¢che : " + JSON.stringify(data));
      }
      fetchTasks(); // Refresh the task list
    }

    // PUT API to update a task
    async function updateTask(taskId, updatedData) {
      const res = await fetch(`${BASE_URL}/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedData),
      });
      if (res.ok) {
        alert("T√¢che mise √† jour avec succ√®s.");
        fetchTasks(); // Refresh the task list
      } else {
        const data = await res.json();
        alert("Erreur lors de la mise √† jour de la t√¢che : " + JSON.stringify(data));
      }
    }

    // Fetch tasks on page load
    fetchTasks();
  </script>
{% endblock %}
