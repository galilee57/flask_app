{% extends "base.html" %}
{% from "components/typography.html" import hero %}
{% from "components/ui.html" import button %}

{% block title %}GAME OF LIFE{% endblock %}

{% block content %}
<div class="bg-white p-8 font-primary">

  {% call hero("GAME OF LIFE 3D", "A simple implementation of Conway's Game of Life in 3D") %}
        {{ info_modal(
            id="test",
            title=md_meta_i18n("docs/projects/game_of_life_3d", "title"),
            text=md_page_i18n("docs/projects/game_of_life_3d"),
            button_label="Infos"
        ) }}
    {% endcall %}

  <div id="rule-panel" class="flex flex-col justify-center-safe gap-3 mb-3
                              bg-secondary-200 border border-primary-600 rounded-lg p-2
                              font-semibold text-sm text-primary-900
                              max-w-md mx-auto">
    
    <label class="me-2w-48">
      B (Birth):
      <input id="rule-b" type="text" value="6" 
            class="form-control d-inline-block w-16 bg-white border border-gray-300 rounded-lg p-2"
            title="Ex : 6 ou 36 (naissance si 3 ou 6 voisins)">
    </label>

    <label class="me-2 w-48">
      S (Survival):
      <input id="rule-s" type="text" value="567" 
            class="form-control d-inline-block w-16 bg-white border border-gray-300 rounded-lg p-2"
            title="Ex : 567 (survie si 5, 6 ou 7 voisins)">
    </label>
    
    <label>
      Density:
      <input id="density" type="range" min="0.02" max="0.40" step="0.01" value="0.12">
      <span id="density-value">0.12</span>
    </label>

    <label class="me-2">
      <input id="torus" type="checkbox" checked> Torus
    </label>

    <select id="rule-preset" class="form-select d-inline-block w-auto bg-white border border-gray-300 rounded-lg p-2">
      <option value="">Presets…</option>
      <option value="6|56">B6/S56 (plutôt stable)</option>
      <option value="6|567">B6/S567 (équilibré)</option>
      <option value="5|45">B5/S45 (chaotique)</option>
    </select>
  </div>

  <div class="flex items-center justify-center p-4">
    {{ button("Apply Rules", id="apply-config", variant="third", extra_class="ms-3") }}
  </div>
  
  <!-- conteneur 3D -->
  <div id="app" class="mb-3 flex justify-center-safe" style="width:100%; height:70vh;"></div>
  <span id="info" class="flex justify-center-safe font-primary font-bold mx-4 mb-2"></span>
  <div class="flex items-center justify-center gap-3">
    {{ button("Start Game", id="start", variant="first", extra_class="mb-3") }}
    {{ button("Stop Game", id="stop", variant="second", extra_class="mb-3") }}
    {{ button("Step", id="step", variant="second", extra_class="mb-3") }}
    {{ button("Apply Reset", id="reset", variant="third", extra_class="mb-3") }}
  </div>
</div>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('game_of_life_3d.static', filename='css/projet_game_of_life_3d.css') }}">
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>

<script>
  // ex: "/projects/game_of_life_3d/"
  const BASE = "{{ url_for('game_of_life_3d.home') }}";
  console.log("BASE URL:", BASE);

  const appEl  = document.getElementById('app');
  const infoEl = document.getElementById('info');
  const densityInput = document.getElementById('density');
  const densityValue = document.getElementById('density-value');

  densityInput.addEventListener('input', () => {
    densityValue.textContent = Number(densityInput.value).toFixed(2);
  });

  // ---------- Anti-intercalage (session/run token + anti-concurrence + abort)
  let run = { id: null, version: null };
  let tickInFlight = false;
  let reqCtrl = null;

  function abortInFlight(){
    if (reqCtrl) { reqCtrl.abort(); reqCtrl = null; }
  }

  async function fetchJSON(url, options = {}) {
    // Annule la requête précédente (utile lors d'un reset/config rapide)
    abortInFlight();
    reqCtrl = new AbortController();
    options.signal = reqCtrl.signal;

    try {
      const res = await fetch(url, options);
      if (res.status === 409) return { stale: true };   // ancienne simulation -> ignore
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (err) {
      if (err.name === 'AbortError') return null;
      throw err;
    }
  }

  // ---------- THREE setup
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0f1115);
  scene.add(new THREE.AmbientLight(0xffffff, 0.35));
  const dir = new THREE.DirectionalLight(0xffffff, 1.0);
  dir.position.set(1,1,1);
  scene.add(dir);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(appEl.clientWidth, appEl.clientHeight);
  appEl.appendChild(renderer.domElement);

  const camera = new THREE.PerspectiveCamera(55, appEl.clientWidth / appEl.clientHeight, 0.1, 2000);
  camera.position.set(40, 40, 40);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
  dirLight.position.set(1, 1, 1);
  scene.add(dirLight);
  scene.add(new THREE.AmbientLight(0xffffff, 0.35));

  let instanced = null;
  let running   = false;
  let timer     = null;
  let shape     = [48, 48, 48];

  function disposeMesh(mesh){
    if (!mesh) return;
    mesh.geometry?.dispose();
    mesh.material?.dispose?.();
    scene.remove(mesh);
  }

  function buildInstanced(alive, shape){
    const [Z, Y, X] = shape;
    const N = alive.length;

    const box = new THREE.BoxGeometry(1,1,1);
    const edgesGeom = new THREE.EdgesGeometry(box, 20);
    const wireMat = new THREE.LineBasicMaterial({
      color: 0x66aaff, transparent: true, opacity: 0.85,
      blending: THREE.AdditiveBlending
    });
    const wire = new THREE.InstancedMesh(edgesGeom, wireMat, Math.max(N,1));
    wire.instanceMatrix.setUsage(THREE.DynamicDrawUsage);

    const innerGeom = new THREE.BoxGeometry(0.65,0.65,0.65);
    const innerMat = new THREE.MeshPhysicalMaterial({ 
      transmission:0.5, thickness:0.4, clearcoat:1.0, clearcoatRoughness:0.1,
      color: 0xffa64d, emissive: 0xff7a1a, emissiveIntensity: 1.4,
      metalness: 0.0, roughness: 0.05,
    });
    const inner = new THREE.InstancedMesh(innerGeom, innerMat, Math.max(N,1));
    inner.instanceMatrix.setUsage(THREE.DynamicDrawUsage);

    const m = new THREE.Matrix4();
    const offset = new THREE.Vector3(-(X-1)/2, -(Y-1)/2, -(Z-1)/2);

    for (let i=0; i<N; i++){
      const [z,y,x] = alive[i];
      m.makeTranslation(x+offset.x, y+offset.y, z+offset.z);
      wire.setMatrixAt(i, m);
      inner.setMatrixAt(i, m);
    }
    wire.count = inner.count = N;
    wire.instanceMatrix.needsUpdate = inner.instanceMatrix.needsUpdate = true;

    const group = new THREE.Group();
    group.add(inner);
    group.add(wire);
    return group;
  }

  function refreshMesh(alive){
    disposeMesh(instanced);
    instanced = buildInstanced(alive, shape);
    scene.add(instanced);
  }

  function updateInfo(data){
    const aliveCount = data.alive.length;
    const [Z, Y, X] = data.config.shape;
    infoEl.textContent = `Alive: ${aliveCount} — Shape: ${X}×${Y}×${Z}`;
  }

  async function loadState(){
    const data = await fetchJSON(`${BASE}state`);
    if (!data || data.stale) return;

    // run token (fourni par backend)
    run.id = data.universe_id;
    run.version = data.version;

    shape = data.config.shape;
    updateInfo(data);
    refreshMesh(data.alive);
  }

  async function tick(){
    if (tickInFlight) return;
    if (!run.id) return;

    tickInFlight = true;

    const res = await fetch(`${BASE}next`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ universe_id: run.id, version: run.version })
    });

    tickInFlight = false;

    if (res.status === 409) return; // stale -> ignore
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    // garde-fou client
    if (data.universe_id !== run.id || data.version !== run.version) return;

    updateInfo(data);
    refreshMesh(data.alive);
  }

  document.getElementById('start').onclick = () => {
    if (running) return;
    running = true;
    if (timer) clearInterval(timer);

    // IMPORTANT: évite le chevauchement, tick() ignore si in-flight
    timer = setInterval(() => { tick(); }, 350);
  };

  document.getElementById('stop').onclick = () => {
    running = false;
    if (timer) { clearInterval(timer); timer = null; }
  };

  document.getElementById('step').onclick = () => tick();

  document.getElementById('reset').onclick = async () => {
    running = false;
    if (timer) { clearInterval(timer); timer = null; }

    abortInFlight();
    tickInFlight = false;

    const data = await fetchJSON(`${BASE}reset`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ density: parseFloat(densityInput.value) })
    });

    if (!data || data.stale) return;

    // reset => nouveau run token
    run.id = data.universe_id;
    run.version = data.version;

    // recharge (ou utilise directement data)
    shape = data.config.shape;
    updateInfo(data);
    refreshMesh(data.alive);
  };

  document.getElementById('rule-preset').addEventListener('change', (e) => {
    const v = e.target.value;
    if (!v) return;
    const [b, s] = v.split('|');
    document.getElementById('rule-b').value = b;
    document.getElementById('rule-s').value = s;
  });

  document.getElementById('apply-config').addEventListener('click', async () => {
    running = false;
    if (timer) { clearInterval(timer); timer = null; }

    abortInFlight();
    tickInFlight = false;

    const rb = document.getElementById('rule-b').value.replace(/\D/g, '');
    const rs = document.getElementById('rule-s').value.replace(/\D/g, '');
    const density = parseFloat(densityInput.value);
    const torus = document.getElementById('torus').checked;

    const data = await fetchJSON(`${BASE}config`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rule_b: rb, rule_s: rs, density, torus })
    });

    if (!data || data.stale) return;

    // config => nouveau run token
    run.id = data.universe_id;
    run.version = data.version;

    shape = data.config.shape;
    updateInfo(data);
    refreshMesh(data.alive);
  });

  window.addEventListener('resize', () => {
    renderer.setSize(appEl.clientWidth, appEl.clientHeight);
    camera.aspect = appEl.clientWidth / appEl.clientHeight;
    camera.updateProjectionMatrix();
  });

  (function render(){
    requestAnimationFrame(render);
    controls.update();
    renderer.render(scene, camera);
  })();

  loadState();
</script>
{% endblock %}
